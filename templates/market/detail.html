{% extends 'base/main.html' %}
{% load i18n %}
{% block main %}
    <style>
        .product-detail-container {
            padding: 30px 0;
        }

        .product-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 60px;
        }

        .product-gallery {
            display: flex;
            flex-direction: column;
        }

        .main-image {
            width: 100%;
            height: 500px;
            overflow: hidden;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #eee;
        }

        .main-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .thumbnail-container {
            display: flex;
            gap: 10px;
        }

        .thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid #ddd;
            cursor: pointer;
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-info h1 {
            font-size: 28px;
            margin-bottom: 15px;
            color: #333;
        }

        .product-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .product-id {
            color: #666;
            font-size: 14px;
        }

        .rating {
            color: #ffc107;
        }

        .rating span {
            color: #666;
            font-size: 14px;
            margin-left: 5px;
        }

        .price-section {
            margin: 25px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .current-price {
            font-size: 28px;
            font-weight: 700;
            color: #e53935;
        }

        .old-price {
            font-size: 18px;
            color: #999;
            text-decoration: line-through;
        }

        .discount-badge {
            background: #e53935;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 14px;
        }

        .product-description {
            margin: 30px 0;
            line-height: 1.6;
        }

        .product-description h3 {
            font-size: 20px;
            margin-bottom: 15px;
        }

        .product-actions {
            display: flex;
            gap: 15px;
            margin: 30px 0;
        }

        .quantity-selector {
            display: flex;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }

        .qty-btn {
            width: 40px;
            height: 40px;
            background: #f5f5f5;
            border: none;
            font-size: 16px;
            cursor: pointer;
        }

        .qty-input {
            width: 50px;
            text-align: center;
            border: none;
            border-left: 1px solid #ddd;
            border-right: 1px solid #ddd;
        }

        .add-to-cart {
            flex: 1;
            background: #4a6de5;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 0 20px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }

        .add-to-cart:hover {
            background: #3a5bd0;
        }

        .wishlist-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            color: #666;
        }

        .wishlist-btn:hover {
            color: #e53935;
        }

        .product-meta-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
        }

        .related-products h2 {
            font-size: 24px;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        /* Responsive design */
        @media (max-width: 992px) {
            .product-detail {
                grid-template-columns: 1fr;
            }

            .main-image {
                height: 400px;
            }
        }

        @media (max-width: 576px) {
            .main-image {
                height: 300px;
            }

            .product-actions {
                flex-direction: column;
            }

            .quantity-selector {
                width: 100%;
            }

            .add-to-cart {
                width: 100%;
                height: 45px;
            }
        }

        .variant-options {
            margin: 20px 0;
        }

        .variant-options h3 {
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .options-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .variant-option {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .variant-option:hover {
            border-color: #999;
        }

        .variant-option.active {
            background-color: #333;
            color: white;
            border-color: #333;
        }

        .wishlist {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
        }
    </style>
    <form id="productForm" action="{% url 'order_item' %}" method="post">
        <div class="product-detail-container">
            <div class="container">
                <div class="product-detail">
                    <!-- Mahsulot rasmlari -->
                    <div class="product-gallery">
                        <div class="main-image">
                            <img src="{{ product.main_image.url }}" alt="{{ product.name }}" id="mainImage">
                        </div>
                        <div class="thumbnail-container">
                            {% for image in product.images.all %}
                                <div class="thumbnail">
                                    <img src="{{ image.image.url }}" alt="{{ product.name }}"
                                         onclick="changeImage(this)">
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Mahsulot ma'lumotlari -->
                    <div class="product-info">
                        <h1>{{ product.name }}</h1>
                        <div class="product-meta">
                            <span class="product-id">Mahsulot ID: {{ product.id }}</span>
                            <div class="rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                                <span>(25 baho)</span>
                            </div>
                        </div>

                        <div class="price-section">
                            {% if product.discount %}
                                <span class="current-price">{{ product.discount_price }} so'm</span>
                                <span class="old-price">{{ product.price }} so'm</span>
                                <span class="discount-badge">-{{ product.discount }}%</span>
                            {% else %}
                                <span class="current-price">{{ product.price }} so'm</span>
                            {% endif %}
                        </div>

                        <div class="product-description">
                            <h3>Tavsif</h3>
                            <p>{{ product.description }}</p>
                        </div>

                        {% csrf_token %}
                        <div class="product-actions">
                            <div class="quantity-selector">
                                <button class="qty-btn minus">-</button>
                                <input type="number" name="quantity" value="1" min="1" max="{{ product.quantity }}"
                                       class="qty-input">
                                <input type="hidden" name="product" value="{{ product.id }}">
                                <input type="hidden" name="user" value="{{ request.user.id }}">
                                <button class="qty-btn plus">+</button>
                            </div>
                            <button type="submit" class="add-to-cart">Savatga qo'shish</button>
                            <button type="button"
                                    class="wishlist {% if product.id in wishlist_products %} active {% endif %}"
                                    data-product-id="{{ product.id }}"
                                    title="Add to Wish List">
                                <i class="fa-heart {% if product.id in wishlist_products %} fas text-danger {% else %} far {% endif %}"></i>
                            </button>

                        </div>


                        <div class="product-meta-info">
                            <div class="meta-item">
                                <i class="fas fa-shield-alt"></i>
                                <span>12 oy kafolat</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-truck"></i>
                                <span>1-3 ish kunida yetkaziladi</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-undo"></i>
                                <span>30 kun ichida qaytarish</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Mahsulot variantlari -->
                <div class="product-variants">
                    {% if product.attributes.exists %}
                        <!-- Variantlar ro'yxati -->
                        <div class="variant-options">
                            <h3>Variantlar:</h3>
                            <div class="options-container">
                                {% for attr in product.attributes.all %}
                                    <div class="variant-option {% if forloop.first %}active{% endif %}"
                                         data-variant-id="{{ attr.id }}"
                                         data-price="{{ attr.price }}">
                                        {{ attr.name }}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                </div>
                <input type="hidden" id="selectedVariant" name="attribute" value="{{ product.attributes.first.id }}">
                <!-- Tavsiya etilgan mahsulotlar -->
            </div>
        </div>
    </form>
    <script>
        // Rasmni almashtirish
        function changeImage(element) {
            const mainImage = document.getElementById('mainImage');
            mainImage.src = element.src;
        }

        // Miqdorni boshqarish
        document.querySelectorAll('.qty-btn').forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault(); // Formani submit bo'lishining oldini olish
                const input = this.parentElement.querySelector('.qty-input');
                let value = parseInt(input.value);
                const max = parseInt(input.getAttribute('max')) || Infinity;

                if (this.classList.contains('minus')) {
                    if (value > 1) {
                        input.value = value - 1;
                    }
                } else {
                    if (value < max) {
                        input.value = value + 1;
                    } else {
                        alert(`Maksimal ${max} ta buyurtma berishingiz mumkin`);
                    }
                }
            });
        });

        // Savatga qo'shish
        document.querySelector('.add-to-cart').addEventListener('click', function (e) {
            const form = this.closest('form');
            const selectedVariant = document.getElementById('selectedVariant').value;
            const quantity = document.querySelector('.qty-input').value;

            // Variant tanlanganligini tekshirish
            if (!selectedVariant) {
                e.preventDefault();
                alert("Iltimos, mahsulot variantini tanlang!");
                return;
            }

            // Miqdorni tekshirish
            const maxQuantity = document.querySelector('.qty-input').getAttribute('max');
            if (parseInt(quantity) > parseInt(maxQuantity)) {
                e.preventDefault();
                alert(`Kechirasiz, maksimal ${maxQuantity} ta buyurtma berishingiz mumkin`);
                return;
            }

            // Agar hamma shartlar bajarilsa, formani yuborish
            form.submit();
        });

        document.addEventListener('DOMContentLoaded', function () {
            const variantOptions = document.querySelectorAll('.variant-option');

            variantOptions.forEach(option => {
                option.addEventListener('click', function () {
                    // Barcha variantlardan active classini olib tashlash
                    variantOptions.forEach(opt => {
                        opt.classList.remove('active');
                    });

                    // Tanlangan variantga active classini qo'shish
                    this.classList.add('active');

                    // Tanlangan variant ma'lumotlarini olish
                    const variantId = this.dataset.variantId;
                    const price = this.dataset.price;

                    // Yashirin maydonga variant ID sini yozish
                    document.getElementById('selectedVariant').value = variantId;

                    // Narxni yangilash
                    const priceElement = document.querySelector('.current-price');
                    if (priceElement && price) {
                        priceElement.textContent = price + ' so\'m';

                        // Agar chegirma bo'lsa, eski narxni yashirish
                        const oldPriceElement = document.querySelector('.old-price');
                        if (oldPriceElement) {
                            oldPriceElement.style.display = 'none';
                        }
                        const discountBadge = document.querySelector('.discount-badge');
                        if (discountBadge) {
                            discountBadge.style.display = 'none';
                        }
                    }
                });
            });

            // Sahifa yuklanganda birinchi variantni tanlash
            if (variantOptions.length > 0) {
                const firstOption = variantOptions[0];
                const variantId = firstOption.dataset.variantId;
                const price = firstOption.dataset.price;

                document.getElementById('selectedVariant').value = variantId;

                // Agar variantda maxsus narx bo'lsa, asosiy narxni o'zgartirish
                if (price && price !== "{{ product.price }}") {
                    const priceElement = document.querySelector('.current-price');
                    if (priceElement) {
                        priceElement.textContent = price + ' so\'m';
                    }
                }
            }
        });
        // Wishlist o'rnatish
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.wishlist').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();

                    const productId = this.dataset.productId;
                    const csrftoken = getCookie('csrftoken');
                    const buttonEl = this;
                    const icon = this.querySelector('i');

                    fetch("{% url 'wishlist-save' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({product: productId})
                    })
                        .then(response => {
                            if (!response.ok) throw new Error('Network error');
                            return response.json();
                        })
                        .then(data => {
                            if (data.status === 'added') {
                                buttonEl.classList.add('active');
                                icon.classList.remove('far');
                                icon.classList.add('fas', 'text-danger');
                            } else if (data.status === 'removed') {
                                buttonEl.classList.remove('active');
                                icon.classList.remove('fas', 'text-danger');
                                icon.classList.add('far');
                            }
                        })
                        .catch(error => console.error('Error:', error));
                });
            });

            // CSRF olish funksiyasi
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>
{% endblock %}